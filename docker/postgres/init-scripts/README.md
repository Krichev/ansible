# PostgreSQL Initialization Scripts

## Overview
This directory contains scripts that run **automatically** when a PostgreSQL Docker container is created with a **fresh volume** (no existing data).

## Important Notes

### When Do These Scripts Run?
- **ONLY on first container startup** with an empty data directory
- Scripts are mounted as read-only via Docker Compose: `./init-scripts:/docker-entrypoint-initdb.d:ro`
- Execution order is alphabetical by filename (hence the numbered prefixes)
- Scripts run **before** PostgreSQL accepts connections

### When Do These Scripts NOT Run?
- If PostgreSQL data volume already exists (container restart)
- If container is recreated but volume is reused
- After manual database modifications

### How to Force Re-Run?
To force scripts to run again, you must delete the PostgreSQL data volume:
```bash
# Stop containers
docker compose down

# Remove volume (⚠️ DESTROYS ALL DATA!)
docker volume rm postgres_pgdata

# Recreate with fresh volume
docker compose up -d
```

## Script Descriptions

### 01-create-karaoke-db.sh
**Purpose:** Creates the Karaoke database and user

**What it does:**
- Creates `karaoke_user` with password from `KARAOKE_DB_PASSWORD` environment variable
- Creates `karaoke_db` database with UTF8 encoding
- Sets `karaoke_user` as owner of `karaoke_db`
- Grants all privileges on the database

**Idempotency:**
- Uses `IF NOT EXISTS` checks to safely run multiple times
- Safe to execute even if user/database already exist

**Required environment variables:**
- `KARAOKE_DB_PASSWORD` (default: `karaoke_password_dev_123`)

---

### 02-custom-hba.sh
**Purpose:** Configures PostgreSQL Host-Based Authentication for external connections

**What it does:**
- Backs up original `pg_hba.conf` to `pg_hba.conf.bak`
- Adds rules to allow external connections from any IP address (IPv4 and IPv6)
- Reloads PostgreSQL configuration without restart

**Security Warning:**
- Allows connections from `0.0.0.0/0` (any IPv4) and `::/0` (any IPv6)
- **ONLY suitable for development environments!**
- For production, edit the script to restrict to specific IP ranges:
  ```
  host    all    all    192.168.1.0/24      scram-sha-256  # Office network
  host    all    all    YOUR_IP/32          scram-sha-256  # Specific IP
  ```

**Idempotency:**
- Appends to existing `pg_hba.conf` (not idempotent - will duplicate entries if run multiple times)
- Only runs during initial setup, so duplication is not an issue

---

### 03-configure-postgresql.sh
**Purpose:** Configures PostgreSQL to listen on all network interfaces

**What it does:**
- Backs up original `postgresql.conf` to `postgresql.conf.bak`
- Sets `listen_addresses = '*'` to bind to all network interfaces
- Default PostgreSQL only listens on `localhost` (127.0.0.1)

**Why is this needed?**
- Without this, PostgreSQL only accepts local connections from within the container
- External applications (PgAdmin, Spring Boot apps, etc.) cannot connect

**Idempotency:**
- Appends to existing `postgresql.conf` (not idempotent - will duplicate entries if run multiple times)
- Only runs during initial setup, so duplication is not an issue

**Network binding:**
- PostgreSQL will bind to `0.0.0.0:5432` (all interfaces)
- Container port mapping (e.g., `5432:5432`) allows external access

---

## Execution Order and Dependencies

1. **01-create-karaoke-db.sh** - Creates database users and databases
2. **02-custom-hba.sh** - Configures connection authentication rules
3. **03-configure-postgresql.sh** - Configures server to listen on all interfaces

**Order matters!** The numbered prefixes ensure correct execution sequence.

## Environment Variables

These scripts use environment variables passed through `docker-compose.yml`:

```yaml
environment:
  POSTGRES_USER: challenger_user       # Default superuser
  POSTGRES_DB: challenger_db           # Default database
  POSTGRES_PASSWORD: ${CHALLENGER_DB_PASSWORD}
  KARAOKE_DB_PASSWORD: ${KARAOKE_DB_PASSWORD}
```

Values come from `.env` file (generated by Ansible from `templates/env.j2`).

## Docker Compose Configuration

Mount location in `docker-compose.yml`:
```yaml
postgres:
  volumes:
    - ./init-scripts:/docker-entrypoint-initdb.d:ro  # Read-only mount
```

The `:ro` flag ensures scripts cannot be modified from within the container.

## Troubleshooting

### Scripts didn't run
**Check:**
1. Is there an existing PostgreSQL data volume?
   ```bash
   docker volume ls | grep pgdata
   ```
2. Check container logs for script execution:
   ```bash
   docker compose logs postgres | grep "init-scripts"
   ```

### Database user not created
**Solution:**
```bash
# Check if scripts ran
docker compose logs postgres | grep "create-karaoke-db"

# If not, force re-run by deleting volume
docker compose down
docker volume rm postgres_pgdata
docker compose up -d
```

### External connections still fail
**Check:**
1. Container port mapping: `docker compose ps`
2. PostgreSQL is listening: `docker exec postgres netstat -tlnp | grep 5432`
3. Firewall rules on host machine
4. HBA configuration: `docker exec postgres cat /var/lib/postgresql/data/pgdata/pg_hba.conf`

### Permission errors in scripts
**Solution:**
```bash
# Ensure scripts are executable
chmod +x docker/postgres/init-scripts/*.sh
```

## Testing External Connections

From your local machine:
```bash
# Test Challenger database
psql -h localhost -p 5432 -U challenger_user -d challenger_db

# Test Karaoke database
psql -h localhost -p 5432 -U karaoke_user -d karaoke_db
```

From PgAdmin:
- Host: `localhost` (or server IP)
- Port: `5432`
- Database: `challenger_db` or `karaoke_db`
- Username: `challenger_user` or `karaoke_user`
- Password: (from `.env` file)

## Related Documentation

- [PostgreSQL Docker Official Image](https://hub.docker.com/_/postgres) - See "Initialization scripts" section
- [pg_hba.conf Documentation](https://www.postgresql.org/docs/15/auth-pg-hba-conf.html)
- [PostgreSQL Connection Configuration](https://www.postgresql.org/docs/15/runtime-config-connection.html)
- [Ansible Scripts README](../../scripts/README.md) - For post-deployment fixes
